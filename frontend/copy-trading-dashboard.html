<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MirrorMaker - Trading Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #0f1419;
      color: #e1e8ed;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .nav-links {
      text-align: center;
      margin-bottom: 20px;
    }

    .nav-links a {
      color: #667eea;
      text-decoration: none;
      padding: 8px 16px;
      border: 1px solid #667eea;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .nav-links a:hover {
      background: #667eea;
      color: #fff;
    }

    h1 {
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    h1 a {
      text-decoration: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    h1 a:hover {
      opacity: 0.8;
    }

    .subtitle {
      color: #8899a6;
      font-size: clamp(0.95rem, 2.5vw, 1.1rem);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #192734;
      border: 1px solid #38444d;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .stat-card:hover {
      transform: translateY(-3px);
      border-color: #667eea;
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
    }

    .stat-label {
      font-size: 0.85em;
      color: #8899a6;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: clamp(1.3rem, 4vw, 1.8rem);
      font-weight: bold;
      color: #e1e8ed;
    }

    .stat-value.positive {
      color: #17bf63;
    }

    .stat-value.negative {
      color: #e0245e;
    }

    .chart-container {
      background: #192734;
      border: 1px solid #38444d;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      min-width: 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .chart-container > div {
      min-width: 300px;
    }

    .chart-container canvas {
      min-height: 300px;
      max-height: 400px;
    }

    .chart-title {
      font-size: clamp(1rem, 3vw, 1.3rem);
      margin-bottom: 15px;
      color: #e1e8ed;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.5em;
      color: #8899a6;
    }

    .error {
      background: #2d1820;
      border: 1px solid #e0245e;
      color: #ff6b9d;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .controls {
      background: #192734;
      border: 1px solid #38444d;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .control-group label {
      font-size: 0.85em;
      color: #8899a6;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input, select, button {
      background: #0f1419;
      border: 1px solid #38444d;
      color: #e1e8ed;
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 1em;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: opacity 0.2s;
    }

    button:hover {
      opacity: 0.9;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .wallet-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .tracked-wallet {
      background: #667eea;
    }

    .user-wallet {
      background: #17bf63;
    }

    .charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    /* Small phones - portrait */
    @media (max-width: 480px) {
      body {
        padding: 10px;
        font-size: 16px;
      }

      .nav-links a {
        display: block;
        margin: 10px 0;
        padding: 12px 16px;
        min-height: 48px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .stat-card {
        padding: 15px;
      }

      .charts-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .chart-container {
        padding: 15px;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
        padding: 15px;
      }

      .control-group {
        width: 100%;
      }

      select, button {
        width: 100%;
        padding: 14px 16px;
        font-size: 16px;
        min-height: 48px;
      }
    }

    /* Mobile and small tablets - portrait */
    @media (min-width: 481px) and (max-width: 768px) {
      body {
        padding: 15px;
      }

      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      .charts-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .chart-container {
        padding: 18px;
      }

      select, button {
        padding: 12px 16px;
        min-height: 44px;
      }
    }

    /* Tablets/iPad - portrait and landscape */
    @media (min-width: 769px) and (max-width: 1024px) {
      body {
        padding: 20px;
      }

      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .charts-row {
        grid-template-columns: 1fr;
        gap: 18px;
      }

      .chart-container {
        padding: 20px;
      }
    }

    /* Large tablets and small desktops */
    @media (min-width: 1025px) and (max-width: 1440px) {
      .charts-row {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* Landscape orientation - mobile devices */
    @media (max-width: 768px) and (orientation: landscape) {
      .charts-row {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1><a href="/dashboard.html">Copy Trading Dashboard</a></h1>
    <p class="subtitle">Tracked vs User wallet comparison</p>
  </div>

  <div class="nav-links">
    <a href="/dashboard.html">View Main Dashboard</a>
  </div>

  <div id="loading" class="loading">Loading snapshot data...</div>
  <div id="error" class="error" style="display: none;"></div>

  <div id="dashboard" style="display: none;">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">
          <span class="wallet-indicator tracked-wallet"></span>Tracked Balance
        </div>
        <div class="stat-value" id="tracked-balance">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <span class="wallet-indicator user-wallet"></span>User Balance
        </div>
        <div class="stat-value" id="user-balance">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Balance Ratio</div>
        <div class="stat-value" id="balance-ratio">0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <span class="wallet-indicator tracked-wallet"></span>Tracked PNL
        </div>
        <div class="stat-value" id="tracked-pnl">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <span class="wallet-indicator user-wallet"></span>User PNL
        </div>
        <div class="stat-value" id="user-pnl">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <span class="wallet-indicator tracked-wallet"></span>Tracked Daily PNL
        </div>
        <div class="stat-value" id="tracked-daily-pnl">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">
          <span class="wallet-indicator user-wallet"></span>User Daily PNL
        </div>
        <div class="stat-value" id="user-daily-pnl">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Snapshots</div>
        <div class="stat-value" id="snapshot-count">0</div>
      </div>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>Viewing Data For:</label>
        <span id="selected-date-display" style="font-weight: bold; font-size: 1.1em;">Today</span>
      </div>
    </div>

    <div class="charts-row">
      <div class="chart-container">
        <div class="chart-title">
          <span class="wallet-indicator tracked-wallet"></span>Tracked Wallet Balance
        </div>
        <canvas id="tracked-balance-chart"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">
          <span class="wallet-indicator user-wallet"></span>User Wallet Balance
        </div>
        <canvas id="user-balance-chart"></canvas>
      </div>
    </div>

    <div class="charts-row">
      <div class="chart-container">
        <div class="chart-title">
          <span class="wallet-indicator tracked-wallet"></span>Tracked Wallet PNL
        </div>
        <canvas id="tracked-pnl-chart"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">
          <span class="wallet-indicator user-wallet"></span>User Wallet PNL
        </div>
        <canvas id="user-pnl-chart"></canvas>
      </div>
    </div>

    <div class="charts-row">
      <div class="chart-container">
        <div class="chart-title">
          <span class="wallet-indicator tracked-wallet"></span>Tracked Position Sizes
        </div>
        <canvas id="tracked-positions-chart"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title">
          <span class="wallet-indicator user-wallet"></span>User Position Sizes
        </div>
        <canvas id="user-positions-chart"></canvas>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-title">Drawdown Analysis</div>
      <canvas id="drawdown-chart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Entry Price Difference % (User vs Tracked)</div>
      <canvas id="entry-diff-chart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Risk Metrics</div>
      <canvas id="risk-chart"></canvas>
    </div>
  </div>

  <script>
    let filteredSnapshots = [];
    let selectedDate = new Date().toISOString().split('T')[0];

    // Consistent color palette for symbols across all charts
    const SYMBOL_COLORS = [
      '#667eea', // purple
      '#17bf63', // green
      '#e0245e', // red
      '#ffad1f', // orange
      '#1da1f2', // blue
      '#f91880', // pink
      '#794bc4', // deep purple
      '#00ba7c', // teal
      '#ff6b6b', // light red
      '#4ecdc4', // cyan
      '#95e1d3', // mint
      '#f38181'  // coral
    ];

    // Hash function to consistently map symbol names to colors
    function getSymbolColor(symbol) {
      let hash = 0;
      for (let i = 0; i < symbol.length; i++) {
        hash = symbol.charCodeAt(i) + ((hash << 5) - hash);
      }
      const index = Math.abs(hash) % SYMBOL_COLORS.length;
      return SYMBOL_COLORS[index];
    }

    // Store chart instances for updates
    let chartInstances = {};

    // Chart.js dark theme configuration
    function getChartConfig(type = 'line', options = {}) {
      return {
        type,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              labels: {
                color: '#e1e8ed',
                font: { size: 12 }
              },
              ...options.legend
            },
            tooltip: {
              backgroundColor: '#192734',
              titleColor: '#e1e8ed',
              bodyColor: '#8899a6',
              borderColor: '#38444d',
              borderWidth: 1
            }
          },
          scales: {
            x: {
              ticks: { color: '#8899a6', font: { size: 11 } },
              grid: { color: '#38444d', display: true },
              type: 'time',
              time: { tooltipFormat: 'MMM d, HH:mm' }
            },
            y: {
              ticks: { color: '#8899a6', font: { size: 11 } },
              grid: { color: '#38444d', display: true },
              ...options.yScale
            },
            ...(options.y2Scale && {
              y2: {
                position: 'right',
                ticks: { color: '#8899a6', font: { size: 11 } },
                grid: { display: false },
                ...options.y2Scale
              }
            })
          },
          ...options.extra
        }
      };
    }

    async function fetchSnapshots(date = null) {
      try {
        const targetDate = date || selectedDate;
        const response = await fetch(`/api/snapshots?date=${targetDate}`);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to fetch snapshots');
        }

        filteredSnapshots = data.snapshots;

        if (filteredSnapshots.length === 0) {
          showError(`No snapshot data available for ${targetDate}. Run the monitor to start collecting data.`);
          return;
        }

        updateSelectedDateDisplay(targetDate);
        renderDashboard();

      } catch (error) {
        showError(`Error loading data: ${error.message}`);
      }
    }

    function updateSelectedDateDisplay(dateStr) {
      const displayEl = document.getElementById('selected-date-display');
      const today = new Date().toISOString().split('T')[0];

      if (dateStr === today) {
        displayEl.textContent = 'Today';
      } else {
        const date = new Date(dateStr);
        displayEl.textContent = date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
      }
    }

    function renderDashboard() {
      if (filteredSnapshots.length === 0) {
        showError('No data available for selected time range');
        return;
      }

      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';

      updateStats();
      renderBalanceChart();
      renderPnlChart();
      renderPositionSizeCharts();
      renderEntryDiffChart();
      renderDrawdownChart();
      renderRiskChart();
    }

    function updateStats() {
      const latest = filteredSnapshots[filteredSnapshots.length - 1];

      document.getElementById('tracked-balance').textContent = `$${latest.tracked.accountValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      document.getElementById('user-balance').textContent = `$${latest.user.accountValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      document.getElementById('balance-ratio').textContent = latest.balanceRatio.toFixed(4);

      const trackedPnl = latest.tracked.totalUnrealizedPnl;
      const userPnl = latest.user.totalUnrealizedPnl;

      const trackedPnlEl = document.getElementById('tracked-pnl');
      const userPnlEl = document.getElementById('user-pnl');

      trackedPnlEl.textContent = `$${trackedPnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      userPnlEl.textContent = `$${userPnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

      trackedPnlEl.className = `stat-value ${trackedPnl >= 0 ? 'positive' : 'negative'}`;
      userPnlEl.className = `stat-value ${userPnl >= 0 ? 'positive' : 'negative'}`;

      const dailyPnl = calculateDailyPnl();

      const trackedDailyPnlEl = document.getElementById('tracked-daily-pnl');
      const userDailyPnlEl = document.getElementById('user-daily-pnl');

      trackedDailyPnlEl.textContent = `$${dailyPnl.tracked.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      userDailyPnlEl.textContent = `$${dailyPnl.user.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

      trackedDailyPnlEl.className = `stat-value ${dailyPnl.tracked >= 0 ? 'positive' : 'negative'}`;
      userDailyPnlEl.className = `stat-value ${dailyPnl.user >= 0 ? 'positive' : 'negative'}`;

      document.getElementById('snapshot-count').textContent = filteredSnapshots.length.toLocaleString();
    }

    function calculateDailyPnl() {
      if (filteredSnapshots.length === 0) {
        return { tracked: 0, user: 0 };
      }

      const latest = filteredSnapshots[filteredSnapshots.length - 1];
      const now = new Date();
      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

      const firstSnapshotOfDay = filteredSnapshots.find(s => s.timestamp >= startOfDay);

      if (!firstSnapshotOfDay) {
        return { tracked: 0, user: 0 };
      }

      const trackedDailyPnl = latest.tracked.accountValue - firstSnapshotOfDay.tracked.accountValue;
      const userDailyPnl = latest.user.accountValue - firstSnapshotOfDay.user.accountValue;

      return {
        tracked: trackedDailyPnl,
        user: userDailyPnl
      };
    }

    function renderBalanceChart() {
      const dates = filteredSnapshots.map(s => new Date(s.timestamp));

      // Tracked Balance Chart
      if (chartInstances['tracked-balance-chart']) chartInstances['tracked-balance-chart'].destroy();
      const trackedCtx = document.getElementById('tracked-balance-chart').getContext('2d');
      chartInstances['tracked-balance-chart'] = new Chart(trackedCtx, {
        ...getChartConfig('line', {
          legend: { display: false },
          yScale: {
            title: { display: true, text: 'Account Value (USD)', color: '#8899a6' },
            ticks: {
              color: '#8899a6',
              font: { size: 11 },
              callback: function(value) {
                return '$' + value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
              }
            }
          }
        }),
        data: {
          labels: dates,
          datasets: [{
            label: 'Tracked Balance',
            data: filteredSnapshots.map(s => s.tracked.accountValue),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            fill: true,
            borderWidth: 3,
            tension: 0.1
          }]
        }
      });

      // User Balance Chart
      if (chartInstances['user-balance-chart']) chartInstances['user-balance-chart'].destroy();
      const userCtx = document.getElementById('user-balance-chart').getContext('2d');
      chartInstances['user-balance-chart'] = new Chart(userCtx, {
        ...getChartConfig('line', {
          legend: { display: false },
          yScale: {
            title: { display: true, text: 'Account Value (USD)', color: '#8899a6' },
            ticks: {
              color: '#8899a6',
              font: { size: 11 },
              callback: function(value) {
                return '$' + value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
              }
            }
          }
        }),
        data: {
          labels: dates,
          datasets: [{
            label: 'User Balance',
            data: filteredSnapshots.map(s => s.user.accountValue),
            borderColor: '#17bf63',
            backgroundColor: 'rgba(23, 191, 99, 0.1)',
            fill: true,
            borderWidth: 3,
            tension: 0.1
          }]
        }
      });
    }

    function renderPnlChart() {
      const dates = filteredSnapshots.map(s => new Date(s.timestamp));

      // Tracked PNL Chart
      if (chartInstances['tracked-pnl-chart']) chartInstances['tracked-pnl-chart'].destroy();
      const trackedCtx = document.getElementById('tracked-pnl-chart').getContext('2d');
      chartInstances['tracked-pnl-chart'] = new Chart(trackedCtx, {
        ...getChartConfig('line', {
          legend: { display: false },
          yScale: {
            title: { display: true, text: 'Unrealized PNL (USD)', color: '#8899a6' },
            ticks: {
              color: '#8899a6',
              font: { size: 11 },
              callback: function(value) {
                return '$' + value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
              }
            }
          }
        }),
        data: {
          labels: dates,
          datasets: [{
            label: 'Tracked PNL',
            data: filteredSnapshots.map(s => s.tracked.totalUnrealizedPnl),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.3)',
            fill: true,
            borderWidth: 3,
            tension: 0.1
          }]
        }
      });

      // User PNL Chart
      if (chartInstances['user-pnl-chart']) chartInstances['user-pnl-chart'].destroy();
      const userCtx = document.getElementById('user-pnl-chart').getContext('2d');
      chartInstances['user-pnl-chart'] = new Chart(userCtx, {
        ...getChartConfig('line', {
          legend: { display: false },
          yScale: {
            title: { display: true, text: 'Unrealized PNL (USD)', color: '#8899a6' },
            ticks: {
              color: '#8899a6',
              font: { size: 11 },
              callback: function(value) {
                return '$' + value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
              }
            }
          }
        }),
        data: {
          labels: dates,
          datasets: [{
            label: 'User PNL',
            data: filteredSnapshots.map(s => s.user.totalUnrealizedPnl),
            borderColor: '#17bf63',
            backgroundColor: 'rgba(23, 191, 99, 0.3)',
            fill: true,
            borderWidth: 3,
            tension: 0.1
          }]
        }
      });
    }

    function renderPositionSizeCharts() {
      const trackedCoinData = {};
      const userCoinData = {};

      filteredSnapshots.forEach(snapshot => {
        const timestamp = new Date(snapshot.timestamp);

        snapshot.tracked.positions.forEach(pos => {
          if (!trackedCoinData[pos.coin]) {
            trackedCoinData[pos.coin] = { x: [], y: [] };
          }
          trackedCoinData[pos.coin].x.push(timestamp);
          trackedCoinData[pos.coin].y.push(pos.notionalValue);
        });

        snapshot.user.positions.forEach(pos => {
          if (!userCoinData[pos.coin]) {
            userCoinData[pos.coin] = { x: [], y: [] };
          }
          userCoinData[pos.coin].x.push(timestamp);
          userCoinData[pos.coin].y.push(pos.notionalValue);
        });
      });

      // Tracked Positions Chart
      const trackedDatasets = Object.entries(trackedCoinData).map(([coin, data]) => ({
        label: coin,
        data: data.x.map((x, i) => ({ x, y: data.y[i] })),
        borderColor: getSymbolColor(coin),
        backgroundColor: getSymbolColor(coin) + '20',
        borderWidth: 2,
        tension: 0.1,
        fill: false
      }));

      if (chartInstances['tracked-positions-chart']) chartInstances['tracked-positions-chart'].destroy();
      const trackedCtx = document.getElementById('tracked-positions-chart').getContext('2d');
      chartInstances['tracked-positions-chart'] = new Chart(trackedCtx, {
        ...getChartConfig('line', {
          legend: { position: 'right' },
          yScale: {
            title: { display: true, text: 'Position Size (USD)', color: '#8899a6' },
            ticks: {
              color: '#8899a6',
              font: { size: 11 },
              callback: function(value) {
                return '$' + value.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
              }
            }
          }
        }),
        data: { datasets: trackedDatasets }
      });

      // User Positions Chart
      const userDatasets = Object.entries(userCoinData).map(([coin, data]) => ({
        label: coin,
        data: data.x.map((x, i) => ({ x, y: data.y[i] })),
        borderColor: getSymbolColor(coin),
        backgroundColor: getSymbolColor(coin) + '20',
        borderWidth: 2,
        tension: 0.1,
        fill: false
      }));

      if (chartInstances['user-positions-chart']) chartInstances['user-positions-chart'].destroy();
      const userCtx = document.getElementById('user-positions-chart').getContext('2d');
      chartInstances['user-positions-chart'] = new Chart(userCtx, {
        ...getChartConfig('line', {
          legend: { position: 'right' },
          yScale: {
            title: { display: true, text: 'Position Size (USD)', color: '#8899a6' },
            ticks: {
              color: '#8899a6',
              font: { size: 11 },
              callback: function(value) {
                return '$' + value.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
              }
            }
          }
        }),
        data: { datasets: userDatasets }
      });
    }

    function renderDrawdownChart() {
      const dates = filteredSnapshots.map(s => new Date(s.timestamp));
      const trackedDrawdown = calculateDrawdown(filteredSnapshots.map(s => s.tracked.accountValue));
      const userDrawdown = calculateDrawdown(filteredSnapshots.map(s => s.user.accountValue));

      if (chartInstances['drawdown-chart']) chartInstances['drawdown-chart'].destroy();
      const ctx = document.getElementById('drawdown-chart').getContext('2d');
      chartInstances['drawdown-chart'] = new Chart(ctx, {
        ...getChartConfig('line', {
          legend: { position: 'bottom', align: 'start' },
          yScale: {
            title: { display: true, text: 'Drawdown (%)', color: '#8899a6' },
            ticks: {
              color: '#8899a6',
              font: { size: 11 },
              callback: function(value) {
                return value.toFixed(2) + '%';
              }
            }
          }
        }),
        data: {
          labels: dates,
          datasets: [
            {
              label: 'Tracked Wallet Drawdown',
              data: trackedDrawdown,
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.3)',
              fill: true,
              borderWidth: 2,
              tension: 0.1
            },
            {
              label: 'User Wallet Drawdown',
              data: userDrawdown,
              borderColor: '#17bf63',
              backgroundColor: 'rgba(23, 191, 99, 0.3)',
              fill: true,
              borderWidth: 2,
              tension: 0.1
            }
          ]
        }
      });
    }

    function calculateDrawdown(accountValues) {
      const drawdowns = [];
      let runningMax = accountValues[0];

      for (let i = 0; i < accountValues.length; i++) {
        const value = accountValues[i];

        if (value > runningMax) {
          runningMax = value;
        }

        const drawdown = ((value - runningMax) / runningMax) * 100;
        drawdowns.push(drawdown);
      }

      return drawdowns;
    }

    function renderEntryDiffChart() {
      const coinData = {};

      filteredSnapshots.forEach(snapshot => {
        const timestamp = new Date(snapshot.timestamp);
        const trackedPositions = {};
        const userPositions = {};

        snapshot.tracked.positions.forEach(pos => {
          trackedPositions[pos.coin] = pos.entryPrice;
        });

        snapshot.user.positions.forEach(pos => {
          userPositions[pos.coin] = pos.entryPrice;
        });

        Object.keys(trackedPositions).forEach(coin => {
          if (userPositions[coin]) {
            if (!coinData[coin]) {
              coinData[coin] = { x: [], y: [] };
            }
            const diffPercent = ((userPositions[coin] - trackedPositions[coin]) / trackedPositions[coin]) * 100;
            coinData[coin].x.push(timestamp);
            coinData[coin].y.push(diffPercent);
          }
        });
      });

      const datasets = Object.entries(coinData).map(([coin, data]) => ({
        label: coin,
        data: data.x.map((x, i) => ({ x, y: data.y[i] })),
        borderColor: getSymbolColor(coin),
        backgroundColor: getSymbolColor(coin),
        borderWidth: 2,
        tension: 0.1,
        fill: false,
        pointRadius: 4,
        pointHoverRadius: 6
      }));

      if (chartInstances['entry-diff-chart']) chartInstances['entry-diff-chart'].destroy();
      const ctx = document.getElementById('entry-diff-chart').getContext('2d');
      chartInstances['entry-diff-chart'] = new Chart(ctx, {
        ...getChartConfig('line', {
          legend: { position: 'right' },
          yScale: {
            title: { display: true, text: 'Entry Price Difference (%)', color: '#8899a6' },
            ticks: {
              color: '#8899a6',
              font: { size: 11 },
              callback: function(value) {
                return value.toFixed(2) + '%';
              }
            }
          }
        }),
        data: { datasets }
      });
    }

    function renderRiskChart() {
      const dates = filteredSnapshots.map(s => new Date(s.timestamp));

      if (chartInstances['risk-chart']) chartInstances['risk-chart'].destroy();
      const ctx = document.getElementById('risk-chart').getContext('2d');
      chartInstances['risk-chart'] = new Chart(ctx, {
        ...getChartConfig('line', {
          legend: { position: 'top', align: 'start' },
          y2Scale: { title: { display: true, text: 'Margin Ratio (%)', color: '#8899a6' } }
        }),
        data: {
          labels: dates,
          datasets: [
            {
              label: 'Tracked Avg Leverage',
              data: filteredSnapshots.map(s => s.tracked.averageLeverage),
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              borderWidth: 2,
              yAxisID: 'y',
              tension: 0.1
            },
            {
              label: 'User Avg Leverage',
              data: filteredSnapshots.map(s => s.user.averageLeverage),
              borderColor: '#17bf63',
              backgroundColor: 'rgba(23, 191, 99, 0.1)',
              borderWidth: 2,
              yAxisID: 'y',
              tension: 0.1
            },
            {
              label: 'Tracked Margin Ratio',
              data: filteredSnapshots.map(s => s.tracked.crossMarginRatio),
              borderColor: '#e0245e',
              backgroundColor: 'rgba(224, 36, 94, 0.1)',
              borderWidth: 2,
              borderDash: [5, 5],
              yAxisID: 'y2',
              tension: 0.1
            },
            {
              label: 'User Margin Ratio',
              data: filteredSnapshots.map(s => s.user.crossMarginRatio),
              borderColor: '#ff6b9d',
              backgroundColor: 'rgba(255, 107, 157, 0.1)',
              borderWidth: 2,
              borderDash: [5, 5],
              yAxisID: 'y2',
              tension: 0.1
            }
          ]
        }
      });
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = message;
    }

    fetchSnapshots();

    setInterval(() => {
      fetchSnapshots();
    }, 60000);
  </script>
</body>
</html>
