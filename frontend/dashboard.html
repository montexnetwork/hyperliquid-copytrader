<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hyperscalper Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #0f1419;
      color: #e1e8ed;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: #8899a6;
      font-size: 1.1em;
    }

    .last-updated {
      color: #657786;
      font-size: 0.9em;
      margin-top: 8px;
    }

    .updating {
      color: #667eea;
      font-weight: bold;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #192734;
      border: 1px solid #38444d;
      border-radius: 12px;
      padding: 20px;
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      border-color: #667eea;
    }

    .stat-label {
      font-size: 0.85em;
      color: #8899a6;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 1.8em;
      font-weight: bold;
      color: #e1e8ed;
    }

    .stat-value.positive {
      color: #17bf63;
    }

    .stat-value.negative {
      color: #e0245e;
    }

    .chart-container {
      background: #192734;
      border: 1px solid #38444d;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 1.3em;
      margin-bottom: 15px;
      color: #e1e8ed;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.5em;
      color: #8899a6;
    }

    .error {
      background: #2d1820;
      border: 1px solid #e0245e;
      color: #ff6b9d;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .controls {
      background: #192734;
      border: 1px solid #38444d;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .control-group label {
      font-size: 0.85em;
      color: #8899a6;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    select, button {
      background: #0f1419;
      border: 1px solid #38444d;
      color: #e1e8ed;
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 1em;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: opacity 0.2s;
    }

    button:hover {
      opacity: 0.9;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      h1 {
        font-size: 1.8em;
      }

      .subtitle {
        font-size: 0.95em;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .stat-card {
        padding: 15px;
      }

      .stat-value {
        font-size: 1.5em;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .chart-container {
        padding: 15px;
      }

      .chart-title {
        font-size: 1.1em;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
        padding: 15px;
      }

      .control-group {
        width: 100%;
      }

      select, button {
        width: 100%;
        padding: 12px 15px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Hyperscalper</h1>
    <p class="last-updated" id="last-updated">Auto-refresh enabled (every 60s)</p>
  </div>

  <div id="loading" class="loading">Loading data...</div>
  <div id="error" class="error" style="display: none;"></div>

  <div id="dashboard" style="display: none;">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Balance</div>
        <div class="stat-value" id="balance">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Current PNL</div>
        <div class="stat-value" id="total-pnl">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Daily PNL</div>
        <div class="stat-value" id="daily-pnl">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Open Positions</div>
        <div class="stat-value" id="position-count">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Margin Usage</div>
        <div class="stat-value" id="margin-used">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg Leverage</div>
        <div class="stat-value" id="avg-leverage">0x</div>
      </div>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>Time Range</label>
        <select id="time-range">
          <option value="all">All Time</option>
          <option value="24h">Last 24 Hours</option>
          <option value="7d">Last 7 Days</option>
          <option value="30d">Last 30 Days</option>
        </select>
      </div>
      <button id="refresh-btn">Refresh Data</button>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <div class="chart-title">Account Balance</div>
        <div id="balance-chart"></div>
      </div>

      <div class="chart-container">
        <div class="chart-title">Unrealized PNL</div>
        <div id="pnl-chart"></div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <div class="chart-title">Position Sizes</div>
        <div id="position-sizes-chart"></div>
      </div>

      <div class="chart-container">
        <div class="chart-title">Position PNL Over Time</div>
        <div id="position-pnl-chart"></div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <div class="chart-title">Drawdown Analysis</div>
        <div id="drawdown-chart"></div>
      </div>

      <div class="chart-container">
        <div class="chart-title">Risk Metrics</div>
        <div id="risk-metrics-chart"></div>
      </div>
    </div>
  </div>

  <script>
    let allSnapshots = [];
    let filteredSnapshots = [];

    function updateLastUpdatedTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      const lastUpdatedEl = document.getElementById('last-updated');
      lastUpdatedEl.textContent = `Last updated: ${timeStr} (auto-refresh every 60s)`;
      lastUpdatedEl.classList.remove('updating');
    }

    async function fetchData(isAutoRefresh = false) {
      try {
        if (isAutoRefresh) {
          const lastUpdatedEl = document.getElementById('last-updated');
          lastUpdatedEl.textContent = 'Updating...';
          lastUpdatedEl.classList.add('updating');
        }

        const response = await fetch('/api/user-snapshots');
        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Failed to fetch data');

        allSnapshots = data.snapshots || [];
        applyTimeFilter();
        updateDashboard();
        updateLastUpdatedTime();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
      } catch (error) {
        document.getElementById('loading').style.display = 'none';
        const errorEl = document.getElementById('error');
        errorEl.textContent = `Error: ${error.message}`;
        errorEl.style.display = 'block';
      }
    }

    function applyTimeFilter() {
      const timeRange = document.getElementById('time-range').value;
      const now = Date.now();

      if (timeRange === 'all') {
        filteredSnapshots = [...allSnapshots];
      } else {
        let cutoffTime;
        if (timeRange === '24h') cutoffTime = now - 24 * 60 * 60 * 1000;
        else if (timeRange === '7d') cutoffTime = now - 7 * 24 * 60 * 60 * 1000;
        else if (timeRange === '30d') cutoffTime = now - 30 * 24 * 60 * 60 * 1000;

        filteredSnapshots = allSnapshots.filter(s => s.timestamp >= cutoffTime);
      }
    }

    function updateDashboard() {
      if (filteredSnapshots.length === 0) return;

      const latest = filteredSnapshots[filteredSnapshots.length - 1].wallet;
      const oldest = filteredSnapshots[0].wallet;

      document.getElementById('balance').textContent = `$${parseFloat(latest.accountValue).toFixed(2)}`;
      document.getElementById('total-pnl').textContent = `$${parseFloat(latest.totalUnrealizedPnl || 0).toFixed(2)}`;
      document.getElementById('total-pnl').className = `stat-value ${(latest.totalUnrealizedPnl || 0) >= 0 ? 'positive' : 'negative'}`;

      const dailyPnl = parseFloat(latest.accountValue) - parseFloat(oldest.accountValue);
      document.getElementById('daily-pnl').textContent = `$${dailyPnl.toFixed(2)}`;
      document.getElementById('daily-pnl').className = `stat-value ${dailyPnl >= 0 ? 'positive' : 'negative'}`;

      document.getElementById('position-count').textContent = latest.positionCount || 0;
      document.getElementById('margin-used').textContent = `$${parseFloat(latest.totalMarginUsed || 0).toFixed(2)}`;
      document.getElementById('avg-leverage').textContent = `${parseFloat(latest.averageLeverage || 0).toFixed(2)}x`;

      renderCharts();
    }

    function renderCharts() {
      const timestamps = filteredSnapshots.map(s => new Date(s.timestamp));
      const balances = filteredSnapshots.map(s => parseFloat(s.wallet.accountValue));
      const pnls = filteredSnapshots.map(s => parseFloat(s.wallet.totalUnrealizedPnl || 0));
      const margins = filteredSnapshots.map(s => parseFloat(s.wallet.totalMarginUsed || 0));
      const leverages = filteredSnapshots.map(s => parseFloat(s.wallet.averageLeverage || 0));

      const commonLayout = {
        plot_bgcolor: '#0f1419',
        paper_bgcolor: '#192734',
        font: { color: '#e1e8ed' },
        xaxis: { gridcolor: '#38444d', showgrid: true },
        yaxis: { gridcolor: '#38444d', showgrid: true },
        margin: { l: 50, r: 20, t: 20, b: 40 }
      };

      Plotly.newPlot('balance-chart', [{
        x: timestamps,
        y: balances,
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        line: { color: '#17bf63', width: 2 }
      }], commonLayout, { responsive: true });

      Plotly.newPlot('pnl-chart', [{
        x: timestamps,
        y: pnls,
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        line: { color: '#667eea', width: 2 }
      }], commonLayout, { responsive: true });

      renderPositionSizes();
      renderPositionPnl();
      renderDrawdown();

      Plotly.newPlot('risk-metrics-chart', [
        {
          x: timestamps,
          y: margins,
          name: 'Margin Used',
          type: 'scatter',
          mode: 'lines',
          line: { color: '#e0245e', width: 2 }
        },
        {
          x: timestamps,
          y: leverages,
          name: 'Avg Leverage',
          type: 'scatter',
          mode: 'lines',
          yaxis: 'y2',
          line: { color: '#ffad1f', width: 2 }
        }
      ], {
        ...commonLayout,
        yaxis: { title: 'Margin ($)', gridcolor: '#38444d' },
        yaxis2: { title: 'Leverage', overlaying: 'y', side: 'right', gridcolor: '#38444d' },
        legend: { x: 0, y: 1 }
      }, { responsive: true });
    }

    function renderPositionSizes() {
      const coinData = {};

      filteredSnapshots.forEach(snapshot => {
        const timestamp = new Date(snapshot.timestamp);
        snapshot.wallet.positions.forEach(pos => {
          if (!coinData[pos.coin]) {
            coinData[pos.coin] = { x: [], y: [] };
          }
          coinData[pos.coin].x.push(timestamp);
          coinData[pos.coin].y.push(pos.notionalValue);
        });
      });

      const traces = Object.entries(coinData).map(([coin, data]) => ({
        x: data.x,
        y: data.y,
        name: coin,
        type: 'scatter',
        mode: 'lines',
        line: { width: 2 }
      }));

      Plotly.newPlot('position-sizes-chart', traces, {
        plot_bgcolor: '#0f1419',
        paper_bgcolor: '#192734',
        font: { color: '#e1e8ed' },
        xaxis: { gridcolor: '#38444d', showgrid: true },
        yaxis: { gridcolor: '#38444d', showgrid: true, title: 'Notional Value ($)' },
        margin: { l: 50, r: 20, t: 20, b: 40 },
        legend: { x: 0, y: 1 }
      }, { responsive: true });
    }

    function renderPositionPnl() {
      const coinData = {};

      filteredSnapshots.forEach(snapshot => {
        const timestamp = new Date(snapshot.timestamp);
        snapshot.wallet.positions.forEach(pos => {
          if (!coinData[pos.coin]) {
            coinData[pos.coin] = { x: [], y: [] };
          }
          coinData[pos.coin].x.push(timestamp);
          coinData[pos.coin].y.push(pos.unrealizedPnl);
        });
      });

      const traces = Object.entries(coinData).map(([coin, data]) => ({
        x: data.x,
        y: data.y,
        name: coin,
        type: 'scatter',
        mode: 'lines',
        line: { width: 2 }
      }));

      Plotly.newPlot('position-pnl-chart', traces, {
        plot_bgcolor: '#0f1419',
        paper_bgcolor: '#192734',
        font: { color: '#e1e8ed' },
        xaxis: { gridcolor: '#38444d', showgrid: true },
        yaxis: { gridcolor: '#38444d', showgrid: true, title: 'Unrealized PNL ($)' },
        margin: { l: 50, r: 20, t: 20, b: 40 },
        legend: { x: 0, y: 1 },
        shapes: [{
          type: 'line',
          x0: filteredSnapshots[0]?.timestamp,
          x1: filteredSnapshots[filteredSnapshots.length - 1]?.timestamp,
          y0: 0,
          y1: 0,
          line: { color: '#38444d', width: 1, dash: 'dash' }
        }]
      }, { responsive: true });
    }

    function renderDrawdown() {
      const timestamps = [];
      const drawdowns = [];
      let peak = 0;

      filteredSnapshots.forEach(snapshot => {
        const balance = parseFloat(snapshot.wallet.accountValue);
        if (balance > peak) {
          peak = balance;
        }
        const drawdown = peak > 0 ? ((balance - peak) / peak) * 100 : 0;
        timestamps.push(new Date(snapshot.timestamp));
        drawdowns.push(drawdown);
      });

      Plotly.newPlot('drawdown-chart', [{
        x: timestamps,
        y: drawdowns,
        type: 'scatter',
        mode: 'lines',
        fill: 'tozeroy',
        line: { color: '#e0245e', width: 2 },
        fillcolor: 'rgba(224, 36, 94, 0.3)'
      }], {
        plot_bgcolor: '#0f1419',
        paper_bgcolor: '#192734',
        font: { color: '#e1e8ed' },
        xaxis: { gridcolor: '#38444d', showgrid: true },
        yaxis: {
          gridcolor: '#38444d',
          showgrid: true,
          title: 'Drawdown (%)',
          tickformat: '.2f'
        },
        margin: { l: 50, r: 20, t: 20, b: 40 },
        shapes: [{
          type: 'line',
          x0: timestamps[0],
          x1: timestamps[timestamps.length - 1],
          y0: 0,
          y1: 0,
          line: { color: '#38444d', width: 1, dash: 'dash' }
        }]
      }, { responsive: true });
    }

    document.getElementById('time-range').addEventListener('change', () => {
      applyTimeFilter();
      updateDashboard();
    });

    document.getElementById('refresh-btn').addEventListener('click', () => {
      document.getElementById('refresh-btn').disabled = true;
      fetchData().finally(() => {
        document.getElementById('refresh-btn').disabled = false;
      });
    });

    fetchData();

    setInterval(() => {
      fetchData(true);
    }, 60000);
  </script>
</body>
</html>
