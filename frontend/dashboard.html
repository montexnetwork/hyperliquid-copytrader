<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hyperscalper Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #1a1a2e 100%);
      color: #e1e8ed;
      padding: 20px;
      overflow-x: hidden;
      max-width: 100vw;
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 50%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(102, 126, 234, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(118, 75, 162, 0.06) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    body > * {
      position: relative;
      z-index: 1;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      margin-bottom: 10px;
      background: linear-gradient(135deg, #00d4ff 0%, #667eea 50%, #a855f7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.3));
    }

    h1 a {
      text-decoration: none;
      background: linear-gradient(135deg, #00d4ff 0%, #667eea 50%, #a855f7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    h1 a:hover {
      opacity: 0.8;
    }

    .subtitle {
      color: #8899a6;
      font-size: clamp(0.95rem, 2.5vw, 1.1rem);
    }

    .last-updated {
      color: #657786;
      font-size: 0.9em;
      margin-top: 8px;
    }

    .updating {
      color: #667eea;
      font-weight: bold;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s ease;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .stat-card:hover {
      transform: translateY(-5px) scale(1.02);
      border-color: rgba(0, 212, 255, 0.5);
      background: rgba(255, 255, 255, 0.08);
      box-shadow:
        0 12px 40px rgba(0, 212, 255, 0.2),
        0 0 20px rgba(0, 212, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .stat-label {
      font-size: 0.85em;
      color: #8899a6;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: clamp(1.3rem, 4vw, 1.8rem);
      font-weight: bold;
      color: #e1e8ed;
    }

    .stat-value.positive {
      color: #17bf63;
    }

    .stat-value.negative {
      color: #e0245e;
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      min-width: 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      transition: all 0.3s ease;
    }

    .chart-container:hover {
      border-color: rgba(0, 212, 255, 0.3);
      box-shadow:
        0 12px 40px rgba(0, 0, 0, 0.4),
        0 0 20px rgba(0, 212, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .chart-container > div {
      min-width: 300px;
    }

    .chart-container canvas {
      min-height: 300px;
      max-height: 400px;
    }

    .chart-title {
      font-size: clamp(1rem, 3vw, 1.3rem);
      margin-bottom: 15px;
      color: #e1e8ed;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .daily-cards-container {
      margin-bottom: 30px;
    }

    .daily-cards-title {
      font-size: 1.3em;
      margin-bottom: 15px;
      color: #e1e8ed;
    }

    .daily-cards-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }

    .daily-card {
      background: rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
      box-shadow:
        0 4px 16px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      min-height: 140px;
    }

    .daily-card:hover {
      transform: translateY(-4px) scale(1.03);
      border-color: rgba(0, 212, 255, 0.4);
      background: rgba(255, 255, 255, 0.07);
      box-shadow:
        0 8px 24px rgba(0, 212, 255, 0.15),
        0 0 15px rgba(0, 212, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .daily-card.selected {
      border-color: rgba(0, 212, 255, 0.6);
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(102, 126, 234, 0.1) 100%);
      box-shadow:
        0 0 25px rgba(0, 212, 255, 0.3),
        0 8px 24px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .daily-card.no-data {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .daily-card-date {
      font-size: 0.75em;
      color: #8899a6;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      text-align: center;
    }

    .daily-card-pnl {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 4px;
      text-align: center;
    }

    .daily-card-pnl.positive {
      color: #17bf63;
    }

    .daily-card-pnl.negative {
      color: #e0245e;
    }

    .daily-card-percent {
      font-size: 0.85em;
      color: #8899a6;
      margin-bottom: 8px;
      text-align: center;
    }

    .daily-card-chart {
      height: 40px;
      margin-top: 8px;
      position: relative;
    }

    .daily-card-chart canvas {
      width: 100% !important;
      height: 40px !important;
    }

    .no-data-text {
      text-align: center;
      color: #657786;
      font-size: 0.9em;
      padding: 20px 0;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.5em;
      color: #8899a6;
    }

    .error {
      background: rgba(224, 36, 94, 0.1);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(224, 36, 94, 0.3);
      color: #ff6b9d;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow:
        0 8px 24px rgba(224, 36, 94, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .controls {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .control-group label {
      font-size: 0.85em;
      color: #8899a6;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    select, button {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #e1e8ed;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.3s ease;
    }

    select:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(0, 212, 255, 0.3);
    }

    button {
      background: linear-gradient(135deg, #00d4ff 0%, #667eea 50%, #a855f7 100%);
      border: none;
      cursor: pointer;
      font-weight: bold;
      box-shadow:
        0 4px 16px rgba(0, 212, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow:
        0 6px 24px rgba(0, 212, 255, 0.4),
        0 0 20px rgba(0, 212, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Small phones - portrait */
    @media (max-width: 480px) {
      body {
        padding: 10px;
        font-size: 16px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .stat-card {
        padding: 15px;
      }

      .charts-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .daily-cards-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .daily-card {
        padding: 12px;
        min-height: 50px;
      }

      .daily-card-pnl {
        font-size: 1em;
      }

      .chart-container {
        padding: 15px;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
        padding: 15px;
      }

      .control-group {
        width: 100%;
      }

      select, button {
        width: 100%;
        padding: 14px 16px;
        font-size: 16px;
        min-height: 48px;
      }
    }

    /* Mobile and small tablets - portrait */
    @media (min-width: 481px) and (max-width: 768px) {
      body {
        padding: 15px;
      }

      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      .charts-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .daily-cards-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }

      .daily-card {
        padding: 12px;
      }

      .chart-container {
        padding: 18px;
      }

      select, button {
        padding: 12px 16px;
        min-height: 44px;
      }
    }

    /* Tablets/iPad - portrait and landscape */
    @media (min-width: 769px) and (max-width: 1024px) {
      body {
        padding: 20px;
      }

      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .charts-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
      }

      .daily-cards-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }

      .chart-container {
        padding: 20px;
      }
    }

    /* Large tablets and small desktops */
    @media (min-width: 1025px) and (max-width: 1440px) {
      .daily-cards-grid {
        grid-template-columns: repeat(5, 1fr);
      }
    }

    /* Landscape orientation - mobile devices */
    @media (max-width: 768px) and (orientation: landscape) {
      .daily-cards-grid {
        grid-template-columns: repeat(4, 1fr);
      }

      .charts-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1><a href="/copy-trading-dashboard.html">Hyperscalper</a></h1>
    <p class="last-updated" id="last-updated">Auto-refresh enabled (every 60s)</p>
  </div>

  <div id="loading" class="loading">Loading data...</div>
  <div id="error" class="error" style="display: none;"></div>

  <div id="dashboard" style="display: none;">
    <div class="daily-cards-container">
      <div class="daily-cards-title">Last 10 Days</div>
      <div class="daily-cards-grid" id="daily-cards-grid">
        <!-- Daily cards will be generated here -->
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Realized Balance</div>
        <div class="stat-value" id="balance-without-pnl">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Balance</div>
        <div class="stat-value" id="balance">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Current PNL</div>
        <div class="stat-value" id="total-pnl">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Daily PNL</div>
        <div class="stat-value" id="daily-pnl">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Open Positions</div>
        <div class="stat-value" id="position-count">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Margin Usage</div>
        <div class="stat-value" id="margin-used">$0</div>
      </div>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>Viewing Data For:</label>
        <span id="selected-date-display" style="font-weight: bold; font-size: 1.1em;">Today</span>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <div class="chart-title">Account Balance</div>
        <canvas id="balance-chart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-title">Unrealized PNL</div>
        <canvas id="pnl-chart"></canvas>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-title">Realized PNL by Symbol</div>
      <canvas id="realized-pnl-chart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Position Sizes</div>
      <canvas id="position-sizes-chart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Position PNL Over Time</div>
      <canvas id="position-pnl-chart"></canvas>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <div class="chart-title">Drawdown Analysis</div>
        <canvas id="drawdown-chart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-title">Risk Metrics</div>
        <canvas id="risk-metrics-chart"></canvas>
      </div>
    </div>
  </div>

  <script>
    let filteredSnapshots = [];
    let allTrades = [];
    let selectedDate = new Date().toISOString().split('T')[0];
    let dailySummaryData = [];

    // Consistent color palette for symbols across all charts
    const SYMBOL_COLORS = [
      '#667eea', // purple
      '#17bf63', // green
      '#e0245e', // red
      '#ffad1f', // orange
      '#1da1f2', // blue
      '#f91880', // pink
      '#794bc4', // deep purple
      '#00ba7c', // teal
      '#ff6b6b', // light red
      '#4ecdc4', // cyan
      '#95e1d3', // mint
      '#f38181'  // coral
    ];

    // Hash function to consistently map symbol names to colors
    function getSymbolColor(symbol) {
      let hash = 0;
      for (let i = 0; i < symbol.length; i++) {
        hash = symbol.charCodeAt(i) + ((hash << 5) - hash);
      }
      const index = Math.abs(hash) % SYMBOL_COLORS.length;
      return SYMBOL_COLORS[index];
    }

    function updateLastUpdatedTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      const lastUpdatedEl = document.getElementById('last-updated');
      lastUpdatedEl.textContent = `Last updated: ${timeStr} (auto-refresh every 60s)`;
      lastUpdatedEl.classList.remove('updating');
    }

    async function fetchData(isAutoRefresh = false, date = null) {
      try {
        if (isAutoRefresh) {
          const lastUpdatedEl = document.getElementById('last-updated');
          lastUpdatedEl.textContent = 'Updating...';
          lastUpdatedEl.classList.add('updating');
        }

        const targetDate = date || selectedDate;
        const [snapshotsRes, tradesRes, summaryRes] = await Promise.all([
          fetch(`/api/user-snapshots?date=${targetDate}`),
          fetch(`/api/trades?date=${targetDate}`),
          fetch('/api/daily-summary?days=10')
        ]);

        const snapshotsData = await snapshotsRes.json();
        const tradesData = await tradesRes.json();
        const summaryData = await summaryRes.json();

        if (!snapshotsRes.ok) throw new Error(snapshotsData.error || 'Failed to fetch snapshots');

        filteredSnapshots = snapshotsData.snapshots || [];
        allTrades = tradesData.trades || [];
        dailySummaryData = summaryData.days || [];

        updateDashboard();
        updateLastUpdatedTime();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
      } catch (error) {
        document.getElementById('loading').style.display = 'none';
        const errorEl = document.getElementById('error');
        errorEl.textContent = `Error: ${error.message}`;
        errorEl.style.display = 'block';
      }
    }

    async function filterByDay(dateStr) {
      selectedDate = dateStr;
      updateSelectedDateDisplay(dateStr);
      await fetchData(false, dateStr);
    }

    function updateSelectedDateDisplay(dateStr) {
      const displayEl = document.getElementById('selected-date-display');
      const today = new Date().toISOString().split('T')[0];

      if (dateStr === today) {
        displayEl.textContent = 'Today';
      } else {
        const date = new Date(dateStr);
        displayEl.textContent = date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
      }
    }

    // Store chart instances for updates
    let chartInstances = {};

    // Chart.js dark theme configuration
    function getChartConfig(type = 'line', options = {}) {
      return {
        type,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              labels: {
                color: '#e1e8ed',
                font: { size: 12 }
              },
              ...options.legend
            },
            tooltip: {
              backgroundColor: '#192734',
              titleColor: '#e1e8ed',
              bodyColor: '#8899a6',
              borderColor: '#38444d',
              borderWidth: 1
            }
          },
          scales: {
            x: {
              ticks: { color: '#8899a6', font: { size: 11 } },
              grid: { color: '#38444d', display: true },
              type: 'time',
              time: { tooltipFormat: 'MMM d, HH:mm' }
            },
            y: {
              ticks: { color: '#8899a6', font: { size: 11 } },
              grid: { color: '#38444d', display: true },
              ...options.yScale
            },
            ...(options.y2Scale && {
              y2: {
                position: 'right',
                ticks: { color: '#8899a6', font: { size: 11 } },
                grid: { display: false },
                ...options.y2Scale
              }
            })
          },
          ...options.extra
        }
      };
    }

    function updateDashboard() {
      if (filteredSnapshots.length === 0) return;

      const latest = filteredSnapshots[filteredSnapshots.length - 1].wallet;
      const oldest = filteredSnapshots[0].wallet;

      document.getElementById('balance').textContent = `$${parseFloat(latest.accountValue).toFixed(2)}`;

      const balanceWithoutPnl = parseFloat(latest.accountValue) - parseFloat(latest.totalUnrealizedPnl || 0);
      document.getElementById('balance-without-pnl').textContent = `$${balanceWithoutPnl.toFixed(2)}`;

      document.getElementById('total-pnl').textContent = `$${parseFloat(latest.totalUnrealizedPnl || 0).toFixed(2)}`;
      document.getElementById('total-pnl').className = `stat-value ${(latest.totalUnrealizedPnl || 0) >= 0 ? 'positive' : 'negative'}`;

      const dailyPnl = parseFloat(latest.accountValue) - parseFloat(oldest.accountValue);
      document.getElementById('daily-pnl').textContent = `$${dailyPnl.toFixed(2)}`;
      document.getElementById('daily-pnl').className = `stat-value ${dailyPnl >= 0 ? 'positive' : 'negative'}`;

      document.getElementById('position-count').textContent = latest.positionCount || 0;
      document.getElementById('margin-used').textContent = `$${parseFloat(latest.totalMarginUsed || 0).toFixed(2)}`;

      renderDailyCards();
      renderCharts();
    }

    function renderCharts() {
      const timestamps = filteredSnapshots.map(s => new Date(s.timestamp));
      const balances = filteredSnapshots.map(s => parseFloat(s.wallet.accountValue));
      const pnls = filteredSnapshots.map(s => parseFloat(s.wallet.totalUnrealizedPnl || 0));
      const margins = filteredSnapshots.map(s => parseFloat(s.wallet.totalMarginUsed || 0));
      const leverages = filteredSnapshots.map(s => parseFloat(s.wallet.averageLeverage || 0));

      // Balance Chart
      if (chartInstances['balance-chart']) chartInstances['balance-chart'].destroy();
      const balanceCtx = document.getElementById('balance-chart').getContext('2d');
      chartInstances['balance-chart'] = new Chart(balanceCtx, {
        ...getChartConfig('line'),
        data: {
          labels: timestamps,
          datasets: [{
            label: 'Account Balance',
            data: balances,
            borderColor: '#17bf63',
            backgroundColor: 'rgba(23, 191, 99, 0.1)',
            fill: true,
            borderWidth: 2,
            tension: 0.1,
            pointRadius: 0
          }]
        }
      });

      // PNL Chart
      if (chartInstances['pnl-chart']) chartInstances['pnl-chart'].destroy();
      const pnlCtx = document.getElementById('pnl-chart').getContext('2d');
      chartInstances['pnl-chart'] = new Chart(pnlCtx, {
        ...getChartConfig('line'),
        data: {
          labels: timestamps,
          datasets: [{
            label: 'Unrealized PNL',
            data: pnls,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            fill: true,
            borderWidth: 2,
            tension: 0.1,
            pointRadius: 0
          }]
        }
      });

      renderPositionSizes();
      renderPositionPnl();
      renderRealizedPnlChart();
      renderDrawdown();

      // Risk Metrics Chart (Dual Y-axis)
      if (chartInstances['risk-metrics-chart']) chartInstances['risk-metrics-chart'].destroy();
      const riskCtx = document.getElementById('risk-metrics-chart').getContext('2d');
      chartInstances['risk-metrics-chart'] = new Chart(riskCtx, {
        ...getChartConfig('line', {
          legend: { position: 'top', align: 'start' },
          y2Scale: { title: { display: true, text: 'Leverage', color: '#8899a6' } }
        }),
        data: {
          labels: timestamps,
          datasets: [
            {
              label: 'Margin Used',
              data: margins,
              borderColor: '#e0245e',
              backgroundColor: 'rgba(224, 36, 94, 0.1)',
              borderWidth: 2,
              yAxisID: 'y',
              tension: 0.1,
              pointRadius: 0
            },
            {
              label: 'Avg Leverage',
              data: leverages,
              borderColor: '#ffad1f',
              backgroundColor: 'rgba(255, 173, 31, 0.1)',
              borderWidth: 2,
              yAxisID: 'y2',
              tension: 0.1,
              pointRadius: 0
            }
          ]
        }
      });
    }

    function renderPositionSizes() {
      const coinData = {};

      filteredSnapshots.forEach(snapshot => {
        const timestamp = new Date(snapshot.timestamp);
        snapshot.wallet.positions.forEach(pos => {
          if (!coinData[pos.coin]) {
            coinData[pos.coin] = { x: [], y: [] };
          }
          coinData[pos.coin].x.push(timestamp);
          coinData[pos.coin].y.push(pos.notionalValue);
        });
      });

      const datasets = Object.entries(coinData).map(([coin, data]) => ({
        label: coin,
        data: data.x.map((x, i) => ({ x, y: data.y[i] })),
        borderColor: getSymbolColor(coin),
        backgroundColor: getSymbolColor(coin) + '20',
        borderWidth: 2,
        tension: 0.1,
        fill: false,
        pointRadius: 0
      }));

      if (chartInstances['position-sizes-chart']) chartInstances['position-sizes-chart'].destroy();
      const ctx = document.getElementById('position-sizes-chart').getContext('2d');
      chartInstances['position-sizes-chart'] = new Chart(ctx, {
        ...getChartConfig('line', {
          legend: { position: 'right' },
          yScale: { title: { display: true, text: 'Notional Value ($)', color: '#8899a6' } }
        }),
        data: { datasets }
      });
    }

    function renderPositionPnl() {
      const coinData = {};

      filteredSnapshots.forEach(snapshot => {
        const timestamp = new Date(snapshot.timestamp);
        snapshot.wallet.positions.forEach(pos => {
          if (!coinData[pos.coin]) {
            coinData[pos.coin] = { x: [], y: [] };
          }
          coinData[pos.coin].x.push(timestamp);
          coinData[pos.coin].y.push(pos.unrealizedPnl);
        });
      });

      const datasets = Object.entries(coinData).map(([coin, data]) => ({
        label: coin,
        data: data.x.map((x, i) => ({ x, y: data.y[i] })),
        borderColor: getSymbolColor(coin),
        backgroundColor: getSymbolColor(coin) + '20',
        borderWidth: 2,
        tension: 0.1,
        fill: false,
        pointRadius: 0
      }));

      if (chartInstances['position-pnl-chart']) chartInstances['position-pnl-chart'].destroy();
      const ctx = document.getElementById('position-pnl-chart').getContext('2d');
      chartInstances['position-pnl-chart'] = new Chart(ctx, {
        ...getChartConfig('line', {
          legend: { position: 'right' },
          yScale: { title: { display: true, text: 'Unrealized PNL ($)', color: '#8899a6' } }
        }),
        data: { datasets }
      });
    }

    function renderDrawdown() {
      const timestamps = [];
      const drawdowns = [];
      let peak = 0;

      filteredSnapshots.forEach(snapshot => {
        const balance = parseFloat(snapshot.wallet.accountValue);
        if (balance > peak) {
          peak = balance;
        }
        const drawdown = peak > 0 ? ((balance - peak) / peak) * 100 : 0;
        timestamps.push(new Date(snapshot.timestamp));
        drawdowns.push(drawdown);
      });

      if (chartInstances['drawdown-chart']) chartInstances['drawdown-chart'].destroy();
      const ctx = document.getElementById('drawdown-chart').getContext('2d');
      chartInstances['drawdown-chart'] = new Chart(ctx, {
        ...getChartConfig('line', {
          yScale: {
            title: { display: true, text: 'Drawdown (%)', color: '#8899a6' },
            ticks: {
              color: '#8899a6',
              font: { size: 11 },
              callback: function(value) {
                return value.toFixed(2) + '%';
              }
            }
          }
        }),
        data: {
          labels: timestamps,
          datasets: [{
            label: 'Drawdown',
            data: drawdowns,
            borderColor: '#e0245e',
            backgroundColor: 'rgba(224, 36, 94, 0.3)',
            fill: true,
            borderWidth: 2,
            tension: 0.1,
            pointRadius: 0
          }]
        }
      });
    }

    function renderRealizedPnlChart() {
      const filteredTrades = allTrades;

      if (filteredTrades.length === 0) {
        if (chartInstances['realized-pnl-chart']) chartInstances['realized-pnl-chart'].destroy();
        const ctx = document.getElementById('realized-pnl-chart').getContext('2d');
        chartInstances['realized-pnl-chart'] = new Chart(ctx, {
          type: 'line',
          data: { datasets: [] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false }
            },
            scales: {
              x: { display: false },
              y: { display: false }
            }
          },
          plugins: [{
            id: 'noDataMessage',
            afterDraw: (chart) => {
              const ctx = chart.ctx;
              const width = chart.width;
              const height = chart.height;
              ctx.save();
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.font = '16px sans-serif';
              ctx.fillStyle = '#657786';
              ctx.fillText('No closed trades', width / 2, height / 2);
              ctx.restore();
            }
          }]
        });
        return;
      }

      const coinData = {};

      filteredTrades
        .sort((a, b) => a.timestamp - b.timestamp)
        .forEach(trade => {
          if (!coinData[trade.coin]) {
            coinData[trade.coin] = {
              x: [],
              y: [],
              cumulative: 0
            };
          }

          coinData[trade.coin].cumulative += trade.realizedPnl;
          coinData[trade.coin].x.push(new Date(trade.timestamp));
          coinData[trade.coin].y.push(coinData[trade.coin].cumulative);
        });

      const datasets = Object.entries(coinData).map(([coin, data]) => ({
        label: coin,
        data: data.x.map((x, i) => ({ x, y: data.y[i] })),
        borderColor: getSymbolColor(coin),
        backgroundColor: getSymbolColor(coin),
        borderWidth: 2,
        tension: 0.1,
        fill: false,
        pointRadius: 0
      }));

      if (chartInstances['realized-pnl-chart']) chartInstances['realized-pnl-chart'].destroy();
      const ctx = document.getElementById('realized-pnl-chart').getContext('2d');
      chartInstances['realized-pnl-chart'] = new Chart(ctx, {
        ...getChartConfig('line', {
          legend: { position: 'top', align: 'start' },
          yScale: {
            title: { display: true, text: 'Cumulative Realized PNL ($)', color: '#8899a6' },
            ticks: {
              color: '#8899a6',
              font: { size: 11 },
              callback: function(value) {
                return '$' + value.toFixed(2);
              }
            }
          }
        }),
        data: { datasets }
      });
    }

    async function renderDailyCards() {
      const container = document.getElementById('daily-cards-grid');
      container.innerHTML = '';

      for (const day of dailySummaryData) {
        const card = document.createElement('div');
        card.className = day.hasData ? 'daily-card' : 'daily-card no-data';

        const isSelected = day.date === selectedDate;
        if (isSelected) {
          card.classList.add('selected');
        }

        const date = new Date(day.date);
        const dateLabel = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        if (day.hasData) {
          const pnlClass = day.totalPnl >= 0 ? 'positive' : 'negative';
          const pnlSign = day.totalPnl >= 0 ? '+' : '';

          const chartId = `daily-chart-${day.date}`;
          card.innerHTML = `
            <div class="daily-card-date">${dateLabel}</div>
            <div class="daily-card-pnl ${pnlClass}">
              ${pnlSign}$${day.totalPnl.toFixed(2)}
            </div>
            <div class="daily-card-percent">
              ${pnlSign}${day.pnlPercentage.toFixed(2)}%
            </div>
            <div class="daily-card-chart">
              <canvas id="${chartId}"></canvas>
            </div>
          `;

          card.addEventListener('click', () => filterByDay(day.date));
          container.appendChild(card);

          renderDailyMiniChart(chartId, day.date, pnlClass === 'positive');
        } else {
          card.innerHTML = `
            <div class="daily-card-date">${dateLabel}</div>
            <div class="no-data-text">No Data</div>
          `;
          container.appendChild(card);
        }
      }
    }

    async function renderDailyMiniChart(chartId, date, isPositive) {
      try {
        const response = await fetch(`/api/user-snapshots?date=${date}`);
        const data = await response.json();

        if (!data.snapshots || data.snapshots.length === 0) {
          return;
        }

        const balances = data.snapshots.map(s => parseFloat(s.wallet.accountValue));
        const color = isPositive ? '#17bf63' : '#e0245e';

        const ctx = document.getElementById(chartId);
        if (!ctx) return;

        new Chart(ctx.getContext('2d'), {
          type: 'line',
          data: {
            labels: data.snapshots.map(s => new Date(s.timestamp)),
            datasets: [{
              data: balances,
              borderColor: color,
              backgroundColor: color + '20',
              borderWidth: 1.5,
              tension: 0.3,
              pointRadius: 0,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false }
            },
            scales: {
              x: { display: false },
              y: { display: false }
            },
            elements: {
              line: { borderWidth: 1.5 }
            }
          }
        });
      } catch (error) {
        console.error(`Failed to render mini chart for ${date}:`, error);
      }
    }

    fetchData();

    setInterval(() => {
      fetchData(true);
    }, 60000);
  </script>
</body>
</html>
