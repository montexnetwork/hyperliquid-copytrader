<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hyperscalper - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #1a1a2e 100%);
      color: #e1e8ed;
      padding: 20px;
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 50%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(102, 126, 234, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(118, 75, 162, 0.06) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    body > * {
      position: relative;
      z-index: 1;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      margin-bottom: 10px;
      background: linear-gradient(135deg, #00d4ff 0%, #667eea 50%, #a855f7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.3));
    }

    .subtitle {
      color: #8899a6;
      font-size: clamp(0.95rem, 2.5vw, 1.1rem);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s ease;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .stat-card:hover {
      transform: translateY(-5px) scale(1.02);
      border-color: rgba(0, 212, 255, 0.5);
      background: rgba(255, 255, 255, 0.08);
      box-shadow:
        0 12px 40px rgba(0, 212, 255, 0.2),
        0 0 20px rgba(0, 212, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .stat-label {
      font-size: 0.85em;
      color: #8899a6;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: clamp(1.3rem, 4vw, 1.8rem);
      font-weight: bold;
      color: #e1e8ed;
    }

    .stat-value.positive { color: #17bf63; }
    .stat-value.negative { color: #e0245e; }
    .positive { color: #17bf63; }
    .negative { color: #e0245e; }

    .chart-container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      min-width: 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      transition: all 0.3s ease;
    }

    .chart-container:hover {
      border-color: rgba(0, 212, 255, 0.3);
      box-shadow:
        0 12px 40px rgba(0, 0, 0, 0.4),
        0 0 20px rgba(0, 212, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .chart-container > div { min-width: 300px; }
    .chart-container canvas { min-height: 300px; max-height: 400px; }

    .chart-title {
      font-size: clamp(1rem, 3vw, 1.3rem);
      margin-bottom: 15px;
      color: #e1e8ed;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.5em;
      color: #8899a6;
    }

    .error {
      background: rgba(224, 36, 94, 0.1);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(224, 36, 94, 0.3);
      color: #ff6b9d;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow:
        0 8px 24px rgba(224, 36, 94, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .controls {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .control-group label {
      font-size: 0.85em;
      color: #8899a6;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .wallet-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .tracked-wallet {
      background: linear-gradient(135deg, #00d4ff 0%, #667eea 100%);
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
    }

    .user-wallet {
      background: linear-gradient(135deg, #17bf63 0%, #00d4a0 100%);
      box-shadow: 0 0 10px rgba(23, 191, 99, 0.5);
    }

    .charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 480px) {
      body { padding: 10px; font-size: 16px; }
      .stats-grid { grid-template-columns: 1fr; gap: 10px; }
      .stat-card { padding: 15px; }
      .charts-row { grid-template-columns: 1fr; gap: 15px; }
      .chart-container { padding: 15px; }
      .controls { flex-direction: column; align-items: stretch; padding: 15px; }
      .control-group { width: 100%; }
    }

    @media (min-width: 481px) and (max-width: 768px) {
      body { padding: 15px; }
      .stats-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
      .charts-row { grid-template-columns: 1fr; gap: 15px; }
      .chart-container { padding: 18px; }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      body { padding: 20px; }
      .stats-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
      .charts-row { grid-template-columns: 1fr; gap: 18px; }
      .chart-container { padding: 20px; }
    }

    @media (min-width: 1025px) and (max-width: 1440px) {
      .charts-row { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 768px) and (orientation: landscape) {
      .charts-row { grid-template-columns: repeat(2, 1fr); }
    }

    .daily-cards-container { margin-bottom: 30px; }
    .daily-cards-title { font-size: 1.3em; margin-bottom: 15px; color: #e1e8ed; }
    .daily-cards-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }
    .daily-card {
      background: rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.05);
      min-height: 120px;
    }
    .daily-card:hover {
      transform: translateY(-4px) scale(1.03);
      border-color: rgba(0, 212, 255, 0.4);
      background: rgba(255, 255, 255, 0.07);
      box-shadow: 0 8px 24px rgba(0, 212, 255, 0.15), 0 0 15px rgba(0, 212, 255, 0.1);
    }
    .daily-card.selected {
      border-color: rgba(0, 212, 255, 0.6);
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(102, 126, 234, 0.1) 100%);
      box-shadow: 0 0 25px rgba(0, 212, 255, 0.3), 0 8px 24px rgba(0, 0, 0, 0.3);
    }
    .daily-card.no-data { opacity: 0.5; cursor: not-allowed; }
    .daily-card-date {
      font-size: 0.75em;
      color: #8899a6;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      text-align: center;
    }
    .daily-card-pnl {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 4px;
      text-align: center;
    }
    .daily-card-pnl.positive { color: #17bf63; }
    .daily-card-pnl.negative { color: #e0245e; }
    .daily-card-percent {
      font-size: 0.85em;
      color: #8899a6;
      margin-bottom: 4px;
      text-align: center;
    }
    .daily-card-balance {
      font-size: 0.8em;
      color: #657786;
      text-align: center;
      margin-bottom: 4px;
    }
    .daily-card-chart { height: 40px; margin-top: 8px; }
    .daily-card-chart canvas { width: 100% !important; height: 40px !important; }

    .positions-section {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    .positions-title { font-size: 1.1em; margin-bottom: 15px; color: #e1e8ed; }
    .positions-table { width: 100%; border-collapse: collapse; }
    .positions-table th, .positions-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .positions-table th {
      font-size: 0.8em;
      color: #8899a6;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .positions-table td { font-size: 0.95em; }
    .direction-long {
      color: #17bf63;
      font-weight: bold;
      padding: 4px 8px;
      background: rgba(23, 191, 99, 0.15);
      border-radius: 4px;
    }
    .direction-short {
      color: #e0245e;
      font-weight: bold;
      padding: 4px 8px;
      background: rgba(224, 36, 94, 0.15);
      border-radius: 4px;
    }
    .no-positions { text-align: center; color: #8899a6; padding: 30px; }

    .positions-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .positions-cards { display: none; }

    @media (max-width: 768px) {
      .positions-table { display: none; }
      .positions-cards { display: block; }
    }
    @media (min-width: 769px) {
      .positions-cards { display: none; }
    }
    .position-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .position-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .position-card-coin {
      font-size: 1.1em;
      font-weight: bold;
    }
    .position-card-pnl {
      font-size: 1em;
      font-weight: bold;
    }
    .position-card-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.9em;
    }
    .position-card-row:last-child { border-bottom: none; }
    .position-card-label { color: #8899a6; }
    .position-card-value { color: #e1e8ed; }

    @media (max-width: 480px) {
      .daily-cards-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      .daily-card { padding: 10px; min-height: 100px; }
      .daily-card-pnl { font-size: 1em; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .stat-card { padding: 15px; }
      .stat-value { font-size: 1.2rem; }
    }
    @media (min-width: 481px) and (max-width: 768px) {
      .daily-cards-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
    }
    @media (min-width: 769px) and (max-width: 1024px) {
      .daily-cards-grid { grid-template-columns: repeat(5, 1fr); gap: 12px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Hyperscalper</h1>
  </div>

  <div id="loading" class="loading">Loading snapshot data...</div>
  <div id="error" class="error" style="display: none;"></div>

  <div id="dashboard" style="display: none;">
    <div class="daily-cards-container">
      <div class="daily-cards-title">Last 10 Days</div>
      <div class="daily-cards-grid" id="daily-cards-grid"></div>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>Viewing Data For:</label>
        <span id="selected-date-display" style="font-weight: bold; font-size: 1.1em;">Today</span>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Realized Balance</div>
        <div class="stat-value" id="realized-balance">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Balance</div>
        <div class="stat-value" id="balance">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Current PNL</div>
        <div class="stat-value" id="current-pnl">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Daily PNL</div>
        <div class="stat-value" id="daily-pnl">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Open Positions</div>
        <div class="stat-value" id="position-count">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Margin Usage</div>
        <div class="stat-value" id="margin-used">$0</div>
      </div>
    </div>

    <div class="positions-section">
      <div class="positions-title">Current Positions</div>
      <div id="positions-container"></div>
    </div>

    <div class="chart-container">
      <div class="chart-title">Balance Change (%)</div>
      <canvas id="balance-chart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Unrealized PNL (% of Balance)</div>
      <canvas id="pnl-chart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Position Sizes (% of Balance)</div>
      <canvas id="positions-chart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Realized PnL by Symbol</div>
      <canvas id="realized-pnl-chart"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Entry Price Difference % (User vs Tracked)</div>
      <canvas id="entry-diff-chart"></canvas>
    </div>

    <div class="charts-row">
      <div class="chart-container">
        <div class="chart-title">Drawdown Analysis</div>
        <canvas id="drawdown-chart"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-title">Risk Metrics</div>
        <canvas id="risk-chart"></canvas>
      </div>
    </div>
  </div>

  <script>
    let filteredSnapshots = [];
    let allTrades = [];
    let dailySummaryData = [];
    let selectedDate = new Date().toISOString().split('T')[0];

    const SYMBOL_COLORS = [
      '#667eea', '#17bf63', '#e0245e', '#ffad1f', '#1da1f2', '#f91880',
      '#794bc4', '#00ba7c', '#ff6b6b', '#4ecdc4', '#95e1d3', '#f38181'
    ];

    function getSymbolColor(symbol) {
      let hash = 0;
      for (let i = 0; i < symbol.length; i++) {
        hash = symbol.charCodeAt(i) + ((hash << 5) - hash);
      }
      return SYMBOL_COLORS[Math.abs(hash) % SYMBOL_COLORS.length];
    }

    let chartInstances = {};

    function getChartConfig(type = 'line', options = {}) {
      return {
        type,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#e1e8ed', font: { size: 12 } }, ...options.legend },
            tooltip: {
              backgroundColor: '#192734',
              titleColor: '#e1e8ed',
              bodyColor: '#8899a6',
              borderColor: '#38444d',
              borderWidth: 1
            }
          },
          scales: {
            x: {
              ticks: { color: '#8899a6', font: { size: 11 } },
              grid: { color: '#38444d', display: true },
              type: 'time',
              time: { tooltipFormat: 'MMM d, HH:mm' }
            },
            y: {
              ticks: { color: '#8899a6', font: { size: 11 } },
              grid: { color: '#38444d', display: true },
              ...options.yScale
            },
            ...(options.y2Scale && {
              y2: {
                position: 'right',
                ticks: { color: '#8899a6', font: { size: 11 } },
                grid: { display: false },
                ...options.y2Scale
              }
            })
          },
          ...options.extra
        }
      };
    }

    async function fetchSnapshots(date = null) {
      try {
        const targetDate = date || selectedDate;
        const [snapshotsRes, tradesRes, summaryRes] = await Promise.all([
          fetch(`/api/snapshots?date=${targetDate}`),
          fetch(`/api/trades?date=${targetDate}`),
          fetch('/api/daily-summary?days=10')
        ]);

        const snapshotsData = await snapshotsRes.json();
        const tradesData = await tradesRes.json();
        const summaryData = await summaryRes.json();

        if (!snapshotsRes.ok) {
          throw new Error(snapshotsData.error || 'Failed to fetch snapshots');
        }

        filteredSnapshots = snapshotsData.snapshots;
        allTrades = tradesData.trades || [];
        dailySummaryData = summaryData.days || [];

        if (filteredSnapshots.length === 0) {
          showError(`No snapshot data available for ${targetDate}. Run the monitor to start collecting data.`);
          return;
        }

        updateSelectedDateDisplay(targetDate);
        renderDashboard();
      } catch (error) {
        showError(`Error loading data: ${error.message}`);
      }
    }

    async function filterByDay(dateStr) {
      selectedDate = dateStr;
      updateSelectedDateDisplay(dateStr);
      await fetchSnapshots(dateStr);
    }

    function updateSelectedDateDisplay(dateStr) {
      const displayEl = document.getElementById('selected-date-display');
      const today = new Date().toISOString().split('T')[0];

      if (dateStr === today) {
        displayEl.textContent = 'Today';
      } else {
        const date = new Date(dateStr);
        displayEl.textContent = date.toLocaleDateString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric'
        });
      }
    }

    function renderDashboard() {
      if (filteredSnapshots.length === 0) {
        showError('No data available for selected time range');
        return;
      }

      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';

      renderDailyCards();
      updateStats();
      renderPositionsTable();
      renderBalanceChart();
      renderPnlChart();
      renderPositionSizeCharts();
      renderRealizedPnlChart();
      renderEntryDiffChart();
      renderDrawdownChart();
      renderRiskChart();
    }

    function updateStats() {
      const latest = filteredSnapshots[filteredSnapshots.length - 1];
      const first = filteredSnapshots[0];
      const user = latest.user;

      const realizedBalance = user.accountValue - (user.totalUnrealizedPnl || 0);
      document.getElementById('realized-balance').textContent = `$${realizedBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      document.getElementById('balance').textContent = `$${user.accountValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

      const currentPnl = user.totalUnrealizedPnl || 0;
      const currentPnlEl = document.getElementById('current-pnl');
      currentPnlEl.textContent = `$${currentPnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      currentPnlEl.className = `stat-value ${currentPnl >= 0 ? 'positive' : 'negative'}`;

      const dailyPnl = user.accountValue - first.user.accountValue;
      const dailyPnlEl = document.getElementById('daily-pnl');
      dailyPnlEl.textContent = `$${dailyPnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      dailyPnlEl.className = `stat-value ${dailyPnl >= 0 ? 'positive' : 'negative'}`;

      document.getElementById('position-count').textContent = user.positions?.length || 0;
      document.getElementById('margin-used').textContent = `$${(user.totalMarginUsed || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }

    function renderBalanceChart() {
      const dates = filteredSnapshots.map(s => new Date(s.timestamp));

      const firstTracked = filteredSnapshots[0].tracked.accountValue;
      const firstUser = filteredSnapshots[0].user.accountValue;

      const trackedChangePct = filteredSnapshots.map(s => ((s.tracked.accountValue - firstTracked) / firstTracked) * 100);
      const userChangePct = filteredSnapshots.map(s => ((s.user.accountValue - firstUser) / firstUser) * 100);

      if (chartInstances['balance-chart']) chartInstances['balance-chart'].destroy();
      chartInstances['balance-chart'] = new Chart(document.getElementById('balance-chart').getContext('2d'), {
        ...getChartConfig('line', {
          legend: { position: 'bottom' },
          yScale: {
            title: { display: true, text: 'Change (%)', color: '#8899a6' },
            ticks: { color: '#8899a6', font: { size: 11 }, callback: v => v.toFixed(2) + '%' }
          }
        }),
        data: {
          labels: dates,
          datasets: [
            {
              label: 'Tracked Balance',
              data: trackedChangePct,
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              fill: true, borderWidth: 2, tension: 0.1, pointRadius: 0
            },
            {
              label: 'User Balance',
              data: userChangePct,
              borderColor: '#17bf63',
              backgroundColor: 'rgba(23, 191, 99, 0.1)',
              borderDash: [5, 5],
              fill: true, borderWidth: 2, tension: 0.1, pointRadius: 0
            }
          ]
        }
      });
    }

    function renderPnlChart() {
      const dates = filteredSnapshots.map(s => new Date(s.timestamp));

      const trackedPnlPct = filteredSnapshots.map(s => (s.tracked.totalUnrealizedPnl / s.tracked.accountValue) * 100);
      const userPnlPct = filteredSnapshots.map(s => (s.user.totalUnrealizedPnl / s.user.accountValue) * 100);

      if (chartInstances['pnl-chart']) chartInstances['pnl-chart'].destroy();
      chartInstances['pnl-chart'] = new Chart(document.getElementById('pnl-chart').getContext('2d'), {
        ...getChartConfig('line', {
          legend: { position: 'bottom' },
          yScale: {
            title: { display: true, text: '% of Balance', color: '#8899a6' },
            ticks: { color: '#8899a6', font: { size: 11 }, callback: v => v.toFixed(2) + '%' }
          }
        }),
        data: {
          labels: dates,
          datasets: [
            {
              label: 'Tracked PNL',
              data: trackedPnlPct,
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              fill: true, borderWidth: 2, tension: 0.1, pointRadius: 0
            },
            {
              label: 'User PNL',
              data: userPnlPct,
              borderColor: '#17bf63',
              backgroundColor: 'rgba(23, 191, 99, 0.1)',
              borderDash: [5, 5],
              fill: true, borderWidth: 2, tension: 0.1, pointRadius: 0
            }
          ]
        }
      });
    }

    function renderPositionSizeCharts() {
      const coinData = {};

      filteredSnapshots.forEach(snapshot => {
        const timestamp = new Date(snapshot.timestamp);
        const trackedBalance = snapshot.tracked.accountValue;
        const userBalance = snapshot.user.accountValue;

        (snapshot.tracked.positions || []).forEach(pos => {
          const key = `${pos.coin} (Tracked)`;
          if (!coinData[key]) coinData[key] = { x: [], y: [], type: 'tracked' };
          const pctOfBalance = (pos.notionalValue / trackedBalance) * 100;
          coinData[key].x.push(timestamp);
          coinData[key].y.push(pctOfBalance);
        });

        (snapshot.user.positions || []).forEach(pos => {
          const key = `${pos.coin} (User)`;
          if (!coinData[key]) coinData[key] = { x: [], y: [], type: 'user' };
          const pctOfBalance = (pos.notionalValue / userBalance) * 100;
          coinData[key].x.push(timestamp);
          coinData[key].y.push(pctOfBalance);
        });
      });

      const datasets = Object.entries(coinData).map(([label, data]) => {
        const coin = label.replace(' (Tracked)', '').replace(' (User)', '');
        const isUser = data.type === 'user';
        return {
          label,
          data: data.x.map((x, i) => ({ x, y: data.y[i] })),
          borderColor: getSymbolColor(coin),
          backgroundColor: getSymbolColor(coin) + '20',
          borderWidth: 2,
          borderDash: isUser ? [5, 5] : [],
          tension: 0.1,
          fill: false,
          pointRadius: 0
        };
      });

      if (chartInstances['positions-chart']) chartInstances['positions-chart'].destroy();
      chartInstances['positions-chart'] = new Chart(document.getElementById('positions-chart').getContext('2d'), {
        ...getChartConfig('line', {
          legend: { position: 'bottom' },
          yScale: {
            title: { display: true, text: '% of Balance', color: '#8899a6' },
            ticks: { color: '#8899a6', font: { size: 11 }, callback: v => v.toFixed(1) + '%' }
          }
        }),
        data: { datasets }
      });
    }

    function renderRealizedPnlChart() {
      if (chartInstances['realized-pnl-chart']) chartInstances['realized-pnl-chart'].destroy();
      const ctx = document.getElementById('realized-pnl-chart').getContext('2d');

      if (allTrades.length === 0) {
        chartInstances['realized-pnl-chart'] = new Chart(ctx, {
          type: 'line',
          data: { datasets: [] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false }
            },
            scales: {
              x: { display: false },
              y: { display: false }
            }
          },
          plugins: [{
            id: 'noDataMessage',
            afterDraw: (chart) => {
              const ctx = chart.ctx;
              const width = chart.width;
              const height = chart.height;
              ctx.save();
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.font = '16px sans-serif';
              ctx.fillStyle = '#657786';
              ctx.fillText('No closed trades', width / 2, height / 2);
              ctx.restore();
            }
          }]
        });
        return;
      }

      const coinData = {};

      allTrades
        .sort((a, b) => a.timestamp - b.timestamp)
        .forEach(trade => {
          if (!coinData[trade.coin]) {
            coinData[trade.coin] = { x: [], y: [], cumulative: 0 };
          }
          coinData[trade.coin].cumulative += trade.realizedPnl;
          coinData[trade.coin].x.push(new Date(trade.timestamp));
          coinData[trade.coin].y.push(coinData[trade.coin].cumulative);
        });

      const datasets = Object.entries(coinData).map(([coin, data]) => ({
        label: coin,
        data: data.x.map((x, i) => ({ x, y: data.y[i] })),
        borderColor: getSymbolColor(coin),
        backgroundColor: getSymbolColor(coin),
        borderWidth: 2,
        tension: 0.1,
        fill: false,
        pointRadius: 0
      }));

      chartInstances['realized-pnl-chart'] = new Chart(ctx, {
        ...getChartConfig('line', {
          legend: { position: 'bottom' },
          yScale: {
            title: { display: true, text: 'Cumulative Realized PNL ($)', color: '#8899a6' },
            ticks: { color: '#8899a6', font: { size: 11 }, callback: v => '$' + v.toFixed(2) }
          }
        }),
        data: { datasets }
      });
    }

    function renderDrawdownChart() {
      const dates = filteredSnapshots.map(s => new Date(s.timestamp));
      const trackedDrawdown = calculateDrawdown(filteredSnapshots.map(s => s.tracked.accountValue));
      const userDrawdown = calculateDrawdown(filteredSnapshots.map(s => s.user.accountValue));

      if (chartInstances['drawdown-chart']) chartInstances['drawdown-chart'].destroy();
      chartInstances['drawdown-chart'] = new Chart(document.getElementById('drawdown-chart').getContext('2d'), {
        ...getChartConfig('line', {
          legend: { position: 'bottom' },
          yScale: {
            title: { display: true, text: 'Drawdown (%)', color: '#8899a6' },
            ticks: { color: '#8899a6', font: { size: 11 }, callback: v => v.toFixed(2) + '%' }
          }
        }),
        data: {
          labels: dates,
          datasets: [
            {
              label: 'Tracked Wallet Drawdown',
              data: trackedDrawdown,
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.3)',
              fill: true, borderWidth: 2, tension: 0.1, pointRadius: 0
            },
            {
              label: 'User Wallet Drawdown',
              data: userDrawdown,
              borderColor: '#17bf63',
              backgroundColor: 'rgba(23, 191, 99, 0.3)',
              fill: true, borderWidth: 2, tension: 0.1, pointRadius: 0
            }
          ]
        }
      });
    }

    function calculateDrawdown(accountValues) {
      const drawdowns = [];
      let runningMax = accountValues[0];

      for (let i = 0; i < accountValues.length; i++) {
        const value = accountValues[i];
        if (value > runningMax) runningMax = value;
        drawdowns.push(((value - runningMax) / runningMax) * 100);
      }

      return drawdowns;
    }

    function renderEntryDiffChart() {
      const coinData = {};

      filteredSnapshots.forEach(snapshot => {
        const timestamp = new Date(snapshot.timestamp);
        const trackedPositions = {};
        const userPositions = {};

        (snapshot.tracked.positions || []).forEach(pos => { trackedPositions[pos.coin] = pos.entryPrice; });
        (snapshot.user.positions || []).forEach(pos => { userPositions[pos.coin] = pos.entryPrice; });

        Object.keys(trackedPositions).forEach(coin => {
          if (userPositions[coin]) {
            if (!coinData[coin]) coinData[coin] = { x: [], y: [] };
            const diffPercent = ((userPositions[coin] - trackedPositions[coin]) / trackedPositions[coin]) * 100;
            coinData[coin].x.push(timestamp);
            coinData[coin].y.push(diffPercent);
          }
        });
      });

      const datasets = Object.entries(coinData).map(([coin, data]) => ({
        label: coin,
        data: data.x.map((x, i) => ({ x, y: data.y[i] })),
        borderColor: getSymbolColor(coin),
        backgroundColor: getSymbolColor(coin),
        borderWidth: 2, tension: 0.1, fill: false, pointRadius: 0
      }));

      if (chartInstances['entry-diff-chart']) chartInstances['entry-diff-chart'].destroy();
      chartInstances['entry-diff-chart'] = new Chart(document.getElementById('entry-diff-chart').getContext('2d'), {
        ...getChartConfig('line', {
          legend: { position: 'bottom' },
          yScale: {
            title: { display: true, text: 'Entry Price Difference (%)', color: '#8899a6' },
            ticks: { color: '#8899a6', font: { size: 11 }, callback: v => v.toFixed(2) + '%' }
          }
        }),
        data: { datasets }
      });
    }

    function renderRiskChart() {
      const dates = filteredSnapshots.map(s => new Date(s.timestamp));

      if (chartInstances['risk-chart']) chartInstances['risk-chart'].destroy();
      chartInstances['risk-chart'] = new Chart(document.getElementById('risk-chart').getContext('2d'), {
        ...getChartConfig('line', {
          legend: { position: 'bottom' },
          y2Scale: { title: { display: true, text: 'Margin Ratio (%)', color: '#8899a6' } }
        }),
        data: {
          labels: dates,
          datasets: [
            {
              label: 'Tracked Avg Leverage',
              data: filteredSnapshots.map(s => s.tracked.averageLeverage),
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              borderWidth: 2, yAxisID: 'y', tension: 0.1, pointRadius: 0
            },
            {
              label: 'User Avg Leverage',
              data: filteredSnapshots.map(s => s.user.averageLeverage),
              borderColor: '#17bf63',
              backgroundColor: 'rgba(23, 191, 99, 0.1)',
              borderWidth: 2, yAxisID: 'y', tension: 0.1, pointRadius: 0
            },
            {
              label: 'Tracked Margin Ratio',
              data: filteredSnapshots.map(s => s.tracked.crossMarginRatio),
              borderColor: '#e0245e',
              backgroundColor: 'rgba(224, 36, 94, 0.1)',
              borderWidth: 2, borderDash: [5, 5], yAxisID: 'y2', tension: 0.1, pointRadius: 0
            },
            {
              label: 'User Margin Ratio',
              data: filteredSnapshots.map(s => s.user.crossMarginRatio),
              borderColor: '#ff6b9d',
              backgroundColor: 'rgba(255, 107, 157, 0.1)',
              borderWidth: 2, borderDash: [5, 5], yAxisID: 'y2', tension: 0.1, pointRadius: 0
            }
          ]
        }
      });
    }

    function renderDailyCards() {
      const container = document.getElementById('daily-cards-grid');
      container.innerHTML = '';

      for (const day of dailySummaryData) {
        const card = document.createElement('div');
        card.className = day.hasData ? 'daily-card' : 'daily-card no-data';

        if (day.date === selectedDate) {
          card.classList.add('selected');
        }

        const date = new Date(day.date);
        const dateLabel = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        if (day.hasData) {
          const pnlClass = day.totalPnl >= 0 ? 'positive' : 'negative';
          const pnlSign = day.totalPnl >= 0 ? '+' : '';
          const chartId = `daily-chart-${day.date}`;

          card.innerHTML = `
            <div class="daily-card-date">${dateLabel}</div>
            <div class="daily-card-pnl ${pnlClass}">${pnlSign}$${day.totalPnl.toFixed(2)}</div>
            <div class="daily-card-percent">${pnlSign}${day.pnlPercentage.toFixed(2)}%</div>
            <div class="daily-card-balance">$${day.endBalance.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
            <div class="daily-card-chart"><canvas id="${chartId}"></canvas></div>
          `;
          card.addEventListener('click', () => filterByDay(day.date));
          container.appendChild(card);
          renderDailyMiniChart(chartId, day.date, pnlClass === 'positive');
        } else {
          card.innerHTML = `
            <div class="daily-card-date">${dateLabel}</div>
            <div style="text-align: center; color: #657786; font-size: 0.9em; padding: 20px 0;">No Data</div>
          `;
          container.appendChild(card);
        }
      }
    }

    async function renderDailyMiniChart(chartId, date, isPositive) {
      try {
        const response = await fetch(`/api/snapshots?date=${date}`);
        const data = await response.json();

        if (!data.snapshots || data.snapshots.length === 0) return;

        const balances = data.snapshots.map(s => s.user.accountValue);
        const color = isPositive ? '#17bf63' : '#e0245e';

        const ctx = document.getElementById(chartId);
        if (!ctx) return;

        new Chart(ctx.getContext('2d'), {
          type: 'line',
          data: {
            labels: data.snapshots.map(s => new Date(s.timestamp)),
            datasets: [{
              data: balances,
              borderColor: color,
              backgroundColor: color + '20',
              borderWidth: 1.5,
              tension: 0.3,
              pointRadius: 0,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { enabled: false } },
            scales: { x: { display: false }, y: { display: false } }
          }
        });
      } catch (error) {
        console.error(`Failed to render mini chart for ${date}:`, error);
      }
    }

    function renderPositionsTable() {
      const container = document.getElementById('positions-container');
      const latest = filteredSnapshots[filteredSnapshots.length - 1];
      const userPositions = latest.user.positions || [];
      const trackedPositions = latest.tracked.positions || [];

      const trackedByCoins = {};
      for (const pos of trackedPositions) {
        trackedByCoins[pos.coin] = pos;
      }

      if (userPositions.length === 0) {
        container.innerHTML = '<div class="no-positions">No open positions</div>';
        return;
      }

      let tableHtml = `
        <table class="positions-table">
          <thead>
            <tr>
              <th>Coin</th>
              <th>Direction</th>
              <th>Size</th>
              <th>User Entry</th>
              <th>Tracked Entry</th>
              <th>PNL</th>
            </tr>
          </thead>
          <tbody>
      `;

      let cardsHtml = '<div class="positions-cards">';

      for (const pos of userPositions) {
        const isLong = pos.side === 'long';
        const direction = isLong ? 'LONG' : 'SHORT';
        const directionClass = isLong ? 'direction-long' : 'direction-short';
        const pnl = pos.unrealizedPnl || 0;
        const pnlClass = pnl >= 0 ? 'positive' : 'negative';
        const pnlSign = pnl >= 0 ? '+' : '';
        const trackedPos = trackedByCoins[pos.coin];
        const trackedEntry = trackedPos ? trackedPos.entryPrice : null;
        const sizeFormatted = '$' + Math.abs(pos.notionalValue || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const entryFormatted = '$' + (pos.entryPrice || 0).toLocaleString(undefined, {minimumFractionDigits: 4, maximumFractionDigits: 4});
        const trackedEntryFormatted = trackedEntry ? '$' + trackedEntry.toLocaleString(undefined, {minimumFractionDigits: 4, maximumFractionDigits: 4}) : '-';

        let entryDiffHtml = '';
        let entryDiffText = '';
        if (trackedEntry && pos.entryPrice) {
          const diffPct = ((pos.entryPrice - trackedEntry) / trackedEntry) * 100;
          const isFavorable = isLong ? diffPct < 0 : diffPct > 0;
          const diffClass = isFavorable ? 'positive' : 'negative';
          const diffSign = diffPct >= 0 ? '+' : '';
          entryDiffHtml = `<span class="${diffClass}" style="margin-left: 8px; font-size: 0.85em;">(${diffSign}${diffPct.toFixed(2)}%)</span>`;
          entryDiffText = `<span class="${diffClass}">(${diffSign}${diffPct.toFixed(2)}%)</span>`;
        }

        tableHtml += `
          <tr>
            <td>${pos.coin}</td>
            <td><span class="${directionClass}">${direction}</span></td>
            <td>${sizeFormatted}</td>
            <td>${entryFormatted}${entryDiffHtml}</td>
            <td>${trackedEntryFormatted}</td>
            <td class="${pnlClass}">${pnlSign}$${Math.abs(pnl).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
          </tr>
        `;

        cardsHtml += `
          <div class="position-card">
            <div class="position-card-header">
              <span class="position-card-coin">${pos.coin} <span class="${directionClass}">${direction}</span></span>
              <span class="position-card-pnl ${pnlClass}">${pnlSign}$${Math.abs(pnl).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
            </div>
            <div class="position-card-row">
              <span class="position-card-label">Size</span>
              <span class="position-card-value">${sizeFormatted}</span>
            </div>
            <div class="position-card-row">
              <span class="position-card-label">Entry</span>
              <span class="position-card-value">${entryFormatted} ${entryDiffText}</span>
            </div>
            <div class="position-card-row">
              <span class="position-card-label">Tracked Entry</span>
              <span class="position-card-value">${trackedEntryFormatted}</span>
            </div>
          </div>
        `;
      }

      tableHtml += '</tbody></table>';
      cardsHtml += '</div>';
      container.innerHTML = tableHtml + cardsHtml;
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = message;
    }

    fetchSnapshots();
    setInterval(fetchSnapshots, 60000);
  </script>
</body>
</html>
